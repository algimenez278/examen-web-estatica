---
import Timer from './Timer.astro';
import Button from './Button.astro';
---

<main class="rosco-container">
  <header>
    <h1>Rosco Dev</h1>
    <Timer initialTime="300"/>
    <button id="terminar-juego-btn" class="btn-terminar">Terminar Juego</button>
  </header>

  <section id="rosco-letras" class="rosco" aria-label="Rosco de letras">
    </section>

  <section class="juego-area" aria-label="Zona de juego">
    <article id="definicion-container">
      <h2 id="letra-actual"></h2>
      <p id="definicion-actual"></p>
    </article>

    <input 
      type="text" 
      id="respuesta-input" 
      autocomplete="off" 
      placeholder="Escribe tu respuesta..."
      class="input-response"
    />

    <div class="botones">
      <button id="responder-btn" class="btn-responder">Responder</button>
      <button id="pasar-btn" class="btn-pasar">Pasapalabra</button>
    </div>
  </section>

  <div class="nav-buttons-container">
      <Button href="/rooms/quiz" title="Volver a la habitación anterior" direction="left" />
      <Button href="/rooms/padlock" title="Ir a habitación siguiente"/>
  </div>

  <section id="resultados" class="hidden resultados">
    <h2>Juego Terminado!</h2>
    <p id="puntuacion-final"></p>
  </section>
</main>

<style>
  html, 
  body {
    height: 100%;
  }

  body {
    background-color: var(--base);
    height: 100vh;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow-x: hidden; 
  }

  .rosco-container {
    background: var(--over);
    border-radius: 12px;
    text-align: center;
    max-width: 600px; 
    max-height: 95vh;
    width: 90%; 
    margin: auto;
    box-shadow: 0 4px 8px rgba(255, 255, 255, 0.2);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 1rem; 
  }
  
  .rosco {
    position: relative;
    width: 75vw; 
    max-width: 300px;
    height: auto;
    aspect-ratio: 1 / 1.1;
    margin: 1.3rem auto;
  }
  
  :global(.letra) {
    position: absolute;
    width: 1.8rem;
    height: 1.8rem;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    font-size: 1.4rem;
    user-select: none;
    background-color: var(--sky);
    color: var(--base);
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
    transition: all 0.3s ease;
    transform: translate(-50%, -50%);
  }
  
  :global(.letra.activa) {
    background-color: var(--letter);
    color: white;
    transform: scale(1.1);
    box-shadow: 0 0 10px rgba(243, 156, 18, 0.7);
    z-index: 10;
  }
  
  :global(.letra.acertada) {
    background-color: var(--green);
    color: var(--over);
  }
  
  :global(.letra.fallada) {
    background-color: var(--red);
    color: var(--over);
  }
  
  :global(.letra.pasada) {
    background-color: var(--blue);
    color: var(--over);
  }
  
  .juego-area {
    background-image: linear-gradient(45deg, var(--mauve), var(--sky));
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin: 1rem auto;
    color: black; 
    
    max-height: 180px;
    display: block; 
  }

  .input-response {
    width: 60%; 
    max-width: 300px; 
    height: 1em;
    padding: 0.5em;
    font-size: 1rem;
    border-radius: 4px;
    margin: 1rem auto;
  }
  
  .botones {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap; 
  }
  
  button {
    padding: 8px 8px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
  }
  
  button:hover {
    box-shadow: 0px 0px 5px var(--sky);
  }

  .btn-responder {
    background-color: var(--mauve);
    color: var(--base);
  }
  
  .btn-pasar {
    background-color: var(--sky);
    color: var(--base);
  }
  
  .btn-terminar {
    background-color: var(--red);
    color: white;
    margin-top: 1rem;
  }

  .nav-buttons-container {
    display: flex;
    justify-content: space-around;
    width: 100%;
    padding: 0 1rem;
  }

  .hidden {
    display: none;
  }

  @media (max-width: 425px) {
    .rosco {
      width: 58vw; 
      max-width: 280px; 
    }
    :global(.letra) {
      width: 1.6rem; 
      height: 1.6rem;
      font-size: 1.2rem;
    }
  }

  @media (min-width: 426px) and (max-width: 540px) {
    .rosco {
      width: 46vw; 
      max-width: 320px; 
    }
    :global(.letra) {
      width: 1.8rem;
      height: 1.8rem;
      font-size: 1.4rem;
    }
  }

  @media (min-width: 541px) and (max-width: 767px) {
    .rosco {
      width: 48vw; 
      max-width: 350px;
    }
    :global(.letra) {
      width: 2rem;
      height: 2rem;
      font-size: 1.6rem;
    }
  }

  @media (min-width: 768px) {
    .rosco-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto auto;
      grid-template-areas:
        "header header"
        "rosco juego"
        "nav-buttons nav-buttons";
      align-items: start;
      justify-items: center;
      gap: 1rem;
      padding: 2rem; 
      height: auto;
    }

    header {
      grid-area: header;
      text-align: center;
    }
    .rosco {
      grid-area: rosco;
      width: 100%; 
      max-width: 400px;
      margin: 0;
    }

    :global(.letra) {
      width: 2rem; 
      height: 2rem;
      font-size: 1.2rem;
    }

    .juego-area {
      grid-area: juego;
      max-width: 350px; 
    }

    .nav-buttons-container {
      grid-area: nav-buttons;
      display: flex;
      justify-content: space-evenly;
      align-items: center;
      padding: 0;
      width: 100%;
    }
    .nav-buttons-container :global(.arrow-btn) {
      margin: 0;
    }
    .button-nav-left, .button-nav-right {
      flex-basis: auto;
      width: auto;
      max-width: 150px;
    }
  }

</style>

<script type="module">
  document.addEventListener('DOMContentLoaded', async () => {
    let data;
    try {
      const res = await fetch('/data-rosco/rosco.json');
      if (!res.ok) throw new Error('No se pudo cargar rosco.json');
      data = await res.json();
    } catch (error) {
      console.error('Error cargando rosco.json:', error);
      alert('Error al cargar los datos del rosco. Ver consola.');
      return;
    }
  
    const preguntas = data.rondas;
  
    const roscoEl = document.getElementById('rosco-letras');
    const letraActualEl = document.getElementById('letra-actual');
    const definicionEl = document.getElementById('definicion-actual');
    const respuestaInput = document.getElementById('respuesta-input');
    const responderBtn = document.getElementById('responder-btn');
    const pasarBtn = document.getElementById('pasar-btn');
    const terminarBtn = document.getElementById('terminar-juego-btn');
    const resultadosEl = document.getElementById('resultados');
    const puntuacionEl = document.getElementById('puntuacion-final');

    // Referencias a los nuevos botones de navegación
    const nextRoomButtons = document.querySelectorAll('.arrow-btn'); 
  
    const estado = {
      letraActual: 0,
      letrasAcertadas: {},
      juegoTerminado: false,
    };
  
    const roscoSize = 250;
    const center = roscoSize / 2;
    const radius = 125;
  
    preguntas.forEach((pregunta, index) => {
      pregunta.estado = 'pendiente';
      const div = document.createElement('div');
      div.className = 'letra';
      div.dataset.letra = pregunta.letra;
      div.dataset.index = index;
      div.textContent = pregunta.letra;
  
      const total = preguntas.length;
      const ang = ((2 * Math.PI * index) / total) - Math.PI / 2;
      const x = center + radius * Math.cos(ang);
      const y = center + radius * Math.sin(ang);
  
      div.style.position = 'absolute';
      div.style.left = `${x}px`;
      div.style.top = `${y}px`;
  
      roscoEl.appendChild(div);
      
      nextRoomButtons.forEach((btn) => {
        btn.disabled = true;
        btn.style.cursor = "not-allowed";
        btn.style.opacity = "0.5";
      });
    });
  
    function actualizarPregunta() {
      const pregunta = preguntas[estado.letraActual];
      letraActualEl.textContent = pregunta.letra;
      definicionEl.textContent = pregunta.definicion;
      respuestaInput.value = '';
  
      document.querySelectorAll('.letra').forEach((el, i) => {
        el.classList.remove('activa');
        if (i === estado.letraActual && !el.classList.contains('acertada') && !el.classList.contains('fallada')) {
          el.classList.add('activa');
        }
      });
    }

    function manejarRespuesta() {
  if (estado.juegoTerminado) return;

  const pregunta = preguntas[estado.letraActual];
  const respuesta = respuestaInput.value.trim().toLowerCase();
  const esCorrecta = respuesta === pregunta.respuesta.toLowerCase();

  const letraEl = document.querySelector(`.letra[data-index="${estado.letraActual}"]`);
  
  console.log('Elemento letra encontrado:', letraEl); // Para depuración
  
  if (!letraEl) {
    console.error('No se encontró el elemento de la letra');
    return;
  }

  letraEl.classList.remove('activa', 'acertada', 'fallada', 'pasada');
  
  letraEl.classList.add(esCorrecta ? 'acertada' : 'fallada');

  pregunta.estado = esCorrecta ? 'acertada' : 'fallada';
  
  estado.letrasAcertadas[pregunta.letra] = esCorrecta;

  setTimeout(avanzar, 300);
}
  
    function pasarPalabra() {
      const pregunta = preguntas[estado.letraActual];
      const letraEl = document.querySelector(`.letra[data-letra="${pregunta.letra}"]`);
      letraEl.classList.remove('activa');
      letraEl.classList.add('pasada');
      pregunta.estado = 'pasada';
      pregunta.estado = 'pasada';

      avanzar();
    }
  
    function avanzar() {
  let siguienteIndice = estado.letraActual;

  for (let i = 1; i <= preguntas.length; i++) {
    const index = (siguienteIndice + i) % preguntas.length;
    const estadoPregunta = preguntas[index].estado;

    if (estadoPregunta === 'pendiente' || estadoPregunta === 'pasada') {
      estado.letraActual = index;
      actualizarPregunta();
      return;
    }
  }

  // Si no encontró ninguna letra pendiente o pasada, termina el juego
  terminarJuego();
}

    function terminarJuego() {
      if(estado.juegoTerminado) return;
      estado.juegoTerminado = true;

      document.querySelector('.juego-area').classList.add('hidden');
      document.getElementById('rosco-letras').classList.add('hidden');
      document.getElementById('terminar-juego-btn').classList.add('hidden');
      resultadosEl.classList.remove('hidden'); 

      const aciertos = Object.values(estado.letrasAcertadas).filter(Boolean).length;
      const porcentaje = Math.round((aciertos / preguntas.length) * 100);
      puntuacionEl.textContent = `Acertaste ${aciertos} de ${preguntas.length} letras (${porcentaje}%)`;

      respuestaInput.disabled = true;
      responderBtn.disabled = true;
      pasarBtn.disabled = true;
      terminarBtn.disabled = true;
      
      nextRoomButtons.forEach((btn) => {
        btn.disabled = false;
        btn.style.cursor = "pointer";
        btn.style.opacity = "1";
      });
     }

    document.addEventListener('timer-finished', () => {
      terminarJuego();
    });
  
    responderBtn.addEventListener('click', manejarRespuesta);
    pasarBtn.addEventListener('click', pasarPalabra);
    terminarBtn.addEventListener('click', terminarJuego);
    respuestaInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        manejarRespuesta();
      }
    });

    actualizarPregunta();
  });
  </script>
